# 演化模拟 - 角色分工系统

## 更新时间: 2025-10-20

---

## 🎭 新功能：角色分工系统

实现了一个完整的角色分工系统，让代理有不同的专业化职责，形成更高效的社会结构。

---

## 1. 三种角色

### 🔍 探索者 (Explorer)
**颜色:** 蓝色 (0.3, 0.6, 1.0)

**职责:**
- 优先探索未访问的区域
- 发现食物后留下强烈信息素标记
- 为团队提供地图信息
- 偶尔采集少量食物

**行为特点:**
- 倾向于去未探索的单元格
- 计算周围未探索密度
- 发现食物时留下 +50 的信息素（比普通高一倍）
- 不会走太远（距离限制30单元格）

### 🌾 采集者 (Gatherer)
**颜色:** 绿色 (0.4, 0.9, 0.3)

**职责:**
- 专注于采集和运输食物
- 使用最短路径返回家园
- 高效的食物物流

**行为特点:**
- 记录去食物的路径
- 返回时使用记忆的路径（最短路径）
- 优先采集食物，次要考虑建造
- 在食物丰富区域停留

### 🏗️ 建造者 (Builder)
**颜色:** 橙色 (1.0, 0.5, 0.2)

**职责:**
- 专注于建造结构（巢穴、储藏室、路径）
- 在食物丰富的地方建造
- 维护基础设施

**行为特点:**
- 更高的建造概率（巢穴40%, 储藏35%, 路径15%）
- 优先在食物丰富的区域建造
- 能量充足时专注建造
- 需要时也会采集食物

---

## 2. 基因组扩展

### 新增基因属性

```python
explorer_tendency: float = 0.33  # 探索倾向
gatherer_tendency: float = 0.34  # 采集倾向
builder_tendency_role: float = 0.33  # 建造倾向(角色)
```

### 特点:
- 三个倾向之和归一化为1.0
- 继承和变异时保持归一化
- 交叉繁殖时混合父母的角色倾向
- 自动选择最高倾向作为主要角色

---

## 3. 路径记忆系统

### Agent新增属性

```python
path_to_food: list  # 记录去食物的路径
explored_cells: set  # 记录探索过的单元格
role: str  # Explorer, Gatherer, Builder
```

### 路径记忆工作原理

1. **记录路径** (前往食物时):
   - 每次移动记录 (x, y, direction)
   - 限制路径长度100步
   - 只在未携带食物时记录

2. **使用路径** (返回时):
   - 反向遍历路径列表
   - 计算到路径点的方向
   - 执行转向或前进
   - 到达点后从列表移除

3. **清空路径**:
   - 成功送达食物后清空
   - 准备记录下一次采集路径

---

## 4. 探索系统

### 探索记录
- 自动记录访问过的单元格: `explored_cells.add((x, y))`
- 在每次行动时更新

### 探索策略
```python
def tool_explore_unknown():
    # 优先选择未探索的方向
    if (nx, ny) not in agent.explored_cells:
        score = 100.0  # 高分
    
    # 计算周围未探索密度
    unexplored_nearby = count_unexplored_in_range()
    score += unexplored_nearby * 2.0
```

---

## 5. 文件结构

### 新增文件:
- `logic/role_tools.py` - 角色专用工具函数
  - `tool_explore_unknown()` - 探索未知区域
  - `tool_follow_path_back()` - 沿路径返回
  - `get_nearest_unexplored_direction()` - 找最近未探索方向

### 修改文件:
- `core/advanced_agent.py` - 添加角色和路径记忆
- `policy/policy_advanced.py` - 角色策略分派
  - `policy_explorer()` - 探索者策略
  - `policy_gatherer()` - 采集者策略
  - `policy_builder()` - 建造者策略
- `viz/advanced_render.py` - 显示角色标记和颜色
- `run/advanced_evolution_demo.py` - 统计角色分布

---

## 6. 策略对比

### 优先级对比

**探索者:**
1. 能量低 → 返回
2. 携带食物 → 返回（使用路径）
3. 发现食物 → 标记信息素
4. 主要工作 → 探索未知区域

**采集者:**
1. 能量低 → 返回
2. 携带食物 → 返回（使用路径）
3. 发现食物 → 采集
4. 主要工作 → 寻找和采集食物

**建造者:**
1. 能量低 → 返回
2. 能量充足+食物丰富 → 建造
3. 需要食物 → 采集
4. 主要工作 → 在资源点建造

---

## 7. 视觉改进

### 代理显示
- **颜色编码:** 根据角色显示不同颜色
  - 蓝色 = 探索者
  - 绿色 = 采集者  
  - 橙色 = 建造者
  - 黄色 = 携带食物（覆盖角色颜色）

- **角色标记:** 代理旁边显示emoji
  - 🔍 = 探索者
  - 🌾 = 采集者
  - 🏗 = 建造者

### 统计面板
新增 "Roles" 部分显示:
```
═══ Roles ═══
🔍 Explorers: 8
🌾 Gatherers: 12
🏗️  Builders: 5
```

### 图例更新
添加三种角色的颜色说明

---

## 8. 预期效果

### 团队协作
1. **探索者** 发现新食物源，留下信息素
2. **采集者** 跟随信息素，高效采集和运输
3. **建造者** 在资源点建造基础设施

### 效率提升
- 采集者使用路径记忆，减少无效移动
- 探索者专注探索，快速发现资源
- 建造者专注建造，提高建筑质量

### 自然分工
- 基因决定角色倾向
- 进化会优化角色比例
- 成功的角色配比会被选择

---

## 9. 示例场景

### 场景1: 发现新食物源
```
1. 探索者🔍发现食物，留下强烈信息素
2. 采集者🌾跟随信息素到达
3. 采集者记录路径，来回运输
4. 建造者🏗在附近建造储藏室
5. 形成高效采集站点
```

### 场景2: 最短路径返回
```
1. 采集者前往食物源，路径被记录
2. 找到食物，采集
3. 返回时，反向遍历路径
4. 避开障碍，找到最短路
5. 成功送达，准备下一次
```

---

## 10. 测试要点

运行时观察:

1. **角色分布:**
   - 查看统计面板中的角色数量
   - 是否有合理的分布（不会全是一种）

2. **颜色差异:**
   - 蓝色代理是否在地图边缘探索
   - 绿色代理是否频繁往返食物源
   - 橙色代理是否在食物区建造

3. **路径效率:**
   - 采集者返回时是否走直线
   - 是否避开了之前遇到的障碍

4. **信息素强度:**
   - 探索者发现食物处的信息素是否更强
   - 采集者的路径是否有信息素痕迹

5. **建筑分布:**
   - 建造者是否在食物丰富的地方建造
   - 建筑是否形成集群

---

## 11. 运行命令

```bash
cd /Users/ein/EinDev/OcctStuff/sources/helloworld
./run_advanced.sh
```

---

## 12. 进化预期

经过多代进化后，应该观察到:

1. **角色平衡:** 
   - 系统自动找到最优角色比例
   - 可能是 30% 采集者, 40% 探索者, 30% 建造者

2. **专业化:**
   - 探索者的 explorer_tendency 基因增强
   - 采集者的 gatherer_tendency 基因增强
   - 建造者的 builder_tendency_role 基因增强

3. **效率提升:**
   - 食物收集速度加快
   - 死亡率降低
   - 建筑物分布更合理

---

## 总结

这次更新引入了一个完整的角色分工系统:

✅ **三种专业化角色** - 探索者、采集者、建造者
✅ **路径记忆系统** - 最短路径返回
✅ **探索记录** - 避免重复探索
✅ **基因驱动角色** - 角色由基因决定
✅ **视觉区分** - 颜色和标记
✅ **统计跟踪** - 实时显示角色分布

这让模拟更接近真实的社会性昆虫（如蚂蚁）的行为模式！🐜
